name: CI

on: [push, pull_request, workflow_dispatch]

jobs:
  main:
    name: ${{ matrix.cc }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        cc: [clang-18, gcc-13, gcc-14]
        include:
          - cc: clang-17
            cxx: clang++-17
            os: ubuntu-latest
          - cc: clang-18
            cxx: clang++-18
            cxxflags: -fno-exceptions
            gcov: llvm-cov-18 gcov
            os: ubuntu-latest
          - cc: gcc-13
            cxx: g++-13
            os: ubuntu-latest
          - cc: gcc-14
            cxx: g++-14
            cxxflags: -fno-exceptions
            gcov: gcov-14
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Generate configure script
        run: sh autogen.sh
      - name: Configure, build and run tests
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: ./configure --enable-coverage && make check
      - name: Configure, build and run tests with ${{ matrix.cxxflags }}
        if: ${{ matrix.cxxflags }}
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
          CXXFLAGS: ${{ matrix.cxxflags }}
        run: ./configure --enable-coverage && make check
      - name: Create coverage information
        if: ${{ matrix.gcov }}
        run: ${{ matrix.gcov }} -r *.cpp
        working-directory: tests
      - name: Upload coverage information
        if: ${{ matrix.gcov }}
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          name: ${{ matrix.cc }} on ${{ matrix.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
  msvc:
    name: Windows ${{ matrix.config }} build
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [Debug, Release]
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Configure CMake
        run: cmake -B build
      - name: Build
        run: cmake --build build --config ${{ matrix.config }}
      - name: Run tests
        working-directory: build
        run: ctest -C ${{ matrix.config }}
